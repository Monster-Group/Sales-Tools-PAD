/*-----------------------
 * Site:  Sales-Tools-PAD - controller
 * Author: Clearlove 7*
 * Updated: 2017-12-15 00:11
 * Version: 1.0.0
 * -----------------------*/
"use strict";define(["angular","waves","nprogress","toastr","moment","loading"],function(angular,Waves,NProgress,toastr,moment){return{controller:function($scope,$rootScope,appApi,getOrderStatu,getMillisecond,$timeout){Waves.init(),Waves.attach(".button",["waves-light"]),Waves.attach(".load-more",["waves-green"]),NProgress.done(),$scope.$table=$(".order-table"),$scope.showAddPay=!1,$timeout(function(){$scope.$addModal=$(".add-order-modal"),$scope.$payModal=$(".add-pay-modal"),$scope.$payModal.find(".modal-dialog").css("margin-top","-"+$scope.$payModal.find(".modal-dialog").outerHeight()/2+"px"),$scope.$addModal.hide(),$scope.$payModal.hide(),$scope.$addModal.on("hidden.bs.modal",function(){$(".add-btn").removeClass("active")})},0),$scope.tableScollHeight=$(window).height()-$scope.$table.offset().top-$scope.$table.find("thead").outerHeight()-100,$scope.searchParams={},$scope.pageNum=1,$scope.orderStatus="",appApi.countMatterSum(function(data){$rootScope.countMatterSum=data}),$scope.dt=$scope.$table.dataTable({order:[],bFilter:!1,bPaginate:!1,scrollY:$scope.tableScollHeight,buttons:{},columns:[{data:"orderNo",width:"15%"},{data:"createdTime",width:"16%"},{data:"productDetail",width:"20%"},{data:"promotionName",width:"17%"},{data:"status",width:"10%"},{data:"buyerName",width:"10%"},{data:"buyerMobile",width:"12%"}],columnDefs:[{targets:1,visible:!0,render:function(data,type,row,meta){return moment(data).format("YYYY-MM-DD HH:mm:ss")}},{targets:4,visible:!0,render:function(data,type,row,meta){return getOrderStatu(data)}}],fnInitComplete:function(s){s.oScroll.sY&&$(s.nTable).after($('<a class="load-more">加载更多...</a>')),Waves.attach(".load-more",["waves-green"])}});var loadData=function(fn){0==$("body").find(".inline-loading").length&&$("body").loading(),appApi.searchOrderList($scope.searchParams,$scope.pageNum,function(data){console.log(data),$scope.tableData=data,$scope.pageNum++,1==data.pageNum&&$scope.dt.fnClearTable(),data.pageNum==data.pages?$(".order").find(".load-more").hide():$(".order").find(".load-more").show(),$timeout(function(){$("body").find(".inline-loading").remove()},0),0!=data.list.length&&($scope.dt.fnAddData(data.list),fn&&$timeout(function(){fn()},0))})};loadData(),appApi.listAllPromotion(function(data){console.log(data),$scope.allPromotion=data.list}),$(".order").on("tap",".load-more",function(e){var top=$(".dataTables_scrollBody").scrollTop();loadData(function(){$(".dataTables_scrollBody").scrollTop(top)})}),$scope.$table.on("tap","tbody tr",function(e){var data=$scope.dt.api(!0).row(e.target).data();data&&$scope.$apply(function(){$scope.orderId=data.orderId,$scope.orderNo=data.orderNo,$scope.showDetail=!0,$scope.$broadcast("showDetail",data)})}),$scope.stateClick=function(e,i){console.log(i),$scope.searchParams.orderStatus=i.state},$scope.tuanClick=function(e,i){$scope.searchParams.promotionId=i.promotionId},$scope.search=function(){$(".form-header").find(".error-msg").is(":visible")||($scope.searchParams.startTime=$scope.startTime?moment($scope.startTime).format("YYYY-MM-DD HH:mm:ss"):"",$scope.searchParams.endTime=$scope.endTime?moment($scope.endTime).format("YYYY-MM-DD HH:mm:ss"):"",$scope.pageNum=1,loadData())},$scope.rest=function(){$scope.searchParams={},$(".dropdown-toggle").find(".val").text("请选择"),$scope.pageNum=1,loadData()},$scope.addOrder=function(e){$(e.target).addClass("active"),$rootScope.$broadcast("addOrder")};var detailClose=$scope.$on("detailClose",function(){$scope.showDetail=!1}),addOrderClose=$scope.$on("addOrderClose",function(e){$scope.pageNum=1,loadData()});$scope.$on("$destroy",function(){addOrderClose(),detailClose()})}}});